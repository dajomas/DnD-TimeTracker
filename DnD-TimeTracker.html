<!--

Original repository for this code: https://github.com/dajomas/DnD-TimeTracker

DISCLAIMER:
I have generated this code using Perplexity.ai

This code is released in MIT license

-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>D&D Time Tracker</title>
  <style>
    body { font-family: Arial; margin: 2rem; background: #eee; max-width: 40rem; }

    /* Fancy main time display */
    #display-fancy {
      display: flex;
      align-items: baseline;
      gap: 1.1em;
      margin-bottom: 1rem;
      font-size: 2.1rem;
      letter-spacing: 0.04em;
      font-family: system-ui, sans-serif;
    }
    #display-fancy .days {
      font-weight: bold;
      font-size: 1.3em;
      color: #ba1a1a;
      padding-right: 0.1em;
      min-width: 4em;
    }
    #display-fancy .hmss {
      font-family: "SFMono-Regular", "Consolas", "Menlo", monospace;
      background: #222;
      color: #fff;
      border-radius: 6px;
      padding: 0.07em 0.5em 0.13em 0.5em;
      font-size: 0.98em;
      letter-spacing: 0.06em;
    }

    .controls {
      display: grid;
      grid-template-columns: max-content auto;
      gap: 0.6em 1em;
      margin-bottom: 0.8em;
      align-items: center;
      width: fit-content;
    }
    .controls label {
      text-align: right;
      margin-right: 0.2em;
      min-width: 10em;
      font-weight: normal;
      font-size: 1em;
    }
    .timing-input {
      width: 4ch;
      text-align: right;
      font-variant-numeric: tabular-nums;
      margin-right: 0.1em;
    }
    .main-time-buttons { display: flex; gap: 0.7em; margin-bottom: 1em; }

    .countdown-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5em 1em;
      align-items: center;
      margin-bottom: 0.5em;
    }
    .countdown-controls input[type="number"] {
      width: auto;
      min-width: 2.5em;
      max-width: 2.5em;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .countdown-controls input[type="text"] {
      min-width: 10em;
    }

    button { margin: 0.2rem; }

    .countdown {
      margin: 0.2rem 0;
      padding: 0.3rem 0.4rem;
      background: #ddd;
      border-radius: 4px;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      gap: 0.4em;
      font-size: 0.9rem;
    }
    .countdown-title {
      font-weight: bold;
      max-width: 11em;
      min-width: 11em;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .countdown-time {
      font-family: "SFMono-Regular", "Consolas", "Menlo", monospace;
      padding: 0 0.3em;
      min-width: 5.3em;  /* "HH:MM:SS" width */
      text-align: right;
    }
    .countdown-iter {
      font-size: 0.85em;
      opacity: 0.8;
      min-width: 4.5em;
    }
    .countdown-buttons {
      display: flex;
      gap: 0.2em;
      margin-left: auto;
    }
    .countdown-buttons button {
      font-size: 0.8em;
      padding: 0.1em 0.3em;
    }

    .flashing {
      animation: flash-bg 0.6s alternate infinite;
    }
    @keyframes flash-bg {
      from { background: #ffe0e0; }
      to   { background: #ee5050; }
    }

    #resetAllBtn { margin-left: 0; margin-bottom: 0.7em; }
    .color-picker {
      border: none;
      background: none;
      width: 1.8em;
      height: 1.8em;
      padding: 0;
    }
  </style>
</head>
<body>
  <h1>D&D Time Tracker</h1>

  <!-- Fancy main time display -->
  <div id="display-fancy">
    <span class="days"></span>
    <span class="hmss"></span>
  </div>

  <!-- Main time configuration -->
  <div class="controls">
    <label for="roundInput">Combat Round</label>
    <span>
      <input id="roundInput" type="number" min="1" class="timing-input">
      s
    </span>
    <label for="shortRestInput">Short Rest</label>
    <span>
      <input id="shortRestInput" type="number" min="1" class="timing-input">
      min
    </span>
    <label for="longRestInput">Long Rest</label>
    <span>
      <input id="longRestInput" type="number" min="1" class="timing-input">
      hr
    </span>
    <span></span>
    <button id="saveDurationsBtn">Save Durations</button>
  </div>

  <!-- Main time controls -->
  <div>
    <button id="startBtn">Start</button>
    <button id="pauseBtn">Pause</button>
    <button id="resumeBtn">Resume</button>
    <button id="resetBtn">Reset Tracker</button>
  </div>
  <div class="main-time-buttons">
    <button id="combatBtn">Add Combat Round</button>
    <button id="shortRestBtn">Add Short Rest</button>
    <button id="longRestBtn">Add Long Rest</button>
  </div>

  <hr>

  <!-- Countdown timers -->
  <h2>Countdown Timers</h2>
  <button id="resetAllBtn">Reset All Timers</button>
  <div class="countdown-controls">
    <label>Hours: <input id="cdHour" type="number" min="0" value="0" size="3"></label>
    <label>Minutes: <input id="cdMinute" type="number" min="0" max="59" value="0" size="3"></label>
    <label>Seconds: <input id="cdSecond" type="number" min="0" max="59" value="0" size="3"></label>
    <label>Description: <input id="cdDescription" type="text" placeholder="Optional description"></label>
    <button id="startCountdownBtn">Add Countdown</button>
  </div>
  <div id="countdownList"></div>

  <script>
    /* -------- Persistence -------- */
    function loadConfig() {
      return {
        roundSeconds: parseInt(localStorage.getItem('roundSeconds')) || 6,
        shortRestMinutes: parseInt(localStorage.getItem('shortRestMinutes')) || 60,
        longRestHours: parseInt(localStorage.getItem('longRestHours')) || 8,
        totalSeconds: parseInt(localStorage.getItem('totalSeconds')) || 0,
        countdowns: JSON.parse(localStorage.getItem('countdowns') || '[]')
      };
    }
    function saveConfig() {
      localStorage.setItem('roundSeconds', roundSeconds);
      localStorage.setItem('shortRestMinutes', shortRestMinutes);
      localStorage.setItem('longRestHours', longRestHours);
      localStorage.setItem('totalSeconds', totalSeconds);
      localStorage.setItem('countdowns', JSON.stringify(countdowns));
    }
    function saveTime() {
      localStorage.setItem('totalSeconds', totalSeconds);
    }

    let {roundSeconds, shortRestMinutes, longRestHours, totalSeconds, countdowns} = loadConfig();
    let running = false;
    let mainTimer = null; // drives main time + countdowns

    function getMaxIteration() {
      if (!countdowns.length) return 1;
      return Math.max(...countdowns.map(cd => cd.iteration || 1));
    }
    function updateTitle() {
      const n = getMaxIteration();
      document.title = `D&D Time Tracker [${n}]`;
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("roundInput").value = roundSeconds;
      document.getElementById("shortRestInput").value = shortRestMinutes;
      document.getElementById("longRestInput").value = longRestHours;
      updateDisplay();
      renderCountdowns();
      updateTitle();
    });

    document.getElementById("saveDurationsBtn").onclick = () => {
      roundSeconds = parseInt(document.getElementById("roundInput").value) || 6;
      shortRestMinutes = parseInt(document.getElementById("shortRestInput").value) || 60;
      longRestHours = parseInt(document.getElementById("longRestInput").value) || 8;
      saveConfig();
    };

    /* -------- Fancy main time display -------- */
    function updateDisplay() {
      let s = totalSeconds;
      const days = Math.floor(s / (24 * 3600));
      s %= (24 * 3600);
      const hours = Math.floor(s / 3600);
      s %= 3600;
      const minutes = Math.floor(s / 60);
      s %= 60;
      document.querySelector('#display-fancy .days').textContent =
        `${days} day${days === 1 ? '' : 's'}`;
      document.querySelector('#display-fancy .hmss').textContent =
        `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    /* -------- Main game tick -------- */
    function gameTick() {
      if (!running) return;

      totalSeconds++;
      updateDisplay();

      let changed = false;
      countdowns.forEach(cd => {
        if (cd.running && cd.remaining > 0) {
          cd.remaining--;
          const span = document.getElementById(`cd-${cd.id}`);
          if (span) span.textContent = formatTime(cd.remaining);
          if (cd.remaining === 0) {
            cd.running = false;
            cd.flashing = true;
            cd.finished = true;
          }
          changed = true;
        }
      });

      if (changed) {
        renderCountdowns();
        saveConfig();
      } else {
        saveTime();
      }
    }

    function ensureMainTimer() {
      if (!mainTimer) {
        mainTimer = setInterval(gameTick, 1000);
      }
    }

    /* -------- Main controls -------- */
    document.getElementById("startBtn").onclick = () => {
      running = true;
      ensureMainTimer();
    };
    document.getElementById("pauseBtn").onclick = () => {
      running = false;
    };
    document.getElementById("resumeBtn").onclick = () => {
      running = true;
      ensureMainTimer();
    };

    function addGameSeconds(delta) {
      totalSeconds += delta;
      updateDisplay();

      countdowns.forEach(cd => {
        if (cd.running && cd.remaining > 0) {
          cd.remaining = Math.max(0, cd.remaining - delta);
          if (cd.remaining === 0) {
            cd.running = false;
            cd.flashing = true;
            cd.finished = true;
          }
        }
      });

      renderCountdowns();
      saveConfig();
    }

    document.getElementById("combatBtn").onclick = () => {
      addGameSeconds(roundSeconds);
    };
    document.getElementById("shortRestBtn").onclick = () => {
      addGameSeconds(shortRestMinutes * 60);
    };
    document.getElementById("longRestBtn").onclick = () => {
      addGameSeconds(longRestHours * 3600);
    };

    document.getElementById("resetBtn").onclick = () => {
      totalSeconds = 0;
      updateDisplay();
      saveTime();
    };

    document.getElementById("resetAllBtn").onclick = () => {
      countdowns.forEach(cd => {
        cd.running = false;
        cd.remaining = cd.seconds;
        cd.flashing = false;
        cd.finished = false;
        cd.iteration = 1;
      });
      renderCountdowns();
      saveConfig();
      updateTitle();
    };

    /* -------- Countdown management -------- */
    function addCountdown(seconds, description) {
      const index = countdowns.length + 1;
      const label = (description && description.trim().length > 0)
        ? description.trim()
        : `Timer ${index}`;

      const id = Date.now() + Math.floor(Math.random()*100000);
      countdowns.push({
        id,
        seconds,
        remaining: seconds,
        running: false,     // new timers do NOT start automatically
        flashing: false,
        finished: false,
        iteration: 1,
        totalIteration: 1,
        color: "#ee5050",
        description: label
      });
      renderCountdowns();
      saveConfig();
      updateTitle();
    }

    function renderCountdowns() {
      const list = document.getElementById("countdownList");
      if (!list) return;
      list.innerHTML = '';
      countdowns.forEach(cd => {
        let style = '';
        if (cd.flashing) {
          style = `animation: flash-bg-${cd.id} 0.6s alternate infinite;`;
          injectDynamicKeyframes(cd.id, cd.color || "#ee5050");
        }
        const div = document.createElement('div');
        div.className = 'countdown' + (cd.flashing ? ' flashing' : '');
        div.id = 'cd-section-' + cd.id;
        div.style = style;

        const title = cd.description || 'Timer';

        div.innerHTML = `
          <span class="countdown-title">${title}</span>
          <span class="countdown-time" id="cd-${cd.id}">${formatTime(cd.remaining)}</span>
          <span class="countdown-iter">[${cd.iteration || 1}] [${cd.totalIteration || 1}]</span>
          <input type="color" class="color-picker" value="${cd.color || '#ee5050'}"
                 onchange="window.pickColor(${cd.id}, this.value)">
          <span class="countdown-buttons">
            ${!cd.finished ? `
              <button onclick="window.toggleCountdown(${cd.id})">${cd.running ? 'Pause' : 'Start'}</button>
              <button onclick="window.resetCountdown(${cd.id})">Reset</button>
              <button onclick="window.resetTotalCountdown(${cd.id})">Reset Total</button>
              <button onclick="window.removeCountdown(${cd.id})">X</button>
            ` : `
              <button onclick="window.restartCountdown(${cd.id})">Restart</button>
              <button onclick="window.resetCountdown(${cd.id})">Reset</button>
              <button onclick="window.resetTotalCountdown(${cd.id})">Reset Total</button>
            `}
          </span>
        `;
        list.appendChild(div);
      });
    }

    function injectDynamicKeyframes(id, flashColor) {
      const styleId = "style-flash-"+id;
      let styleElem = document.getElementById(styleId);
      if (!styleElem) {
        styleElem = document.createElement("style");
        styleElem.id = styleId;
        document.head.appendChild(styleElem);
      }
      styleElem.textContent = `
      @keyframes flash-bg-${id} {
        from { background: #ffe0e0; }
        to   { background: ${flashColor}; }
      }`;
    }

    window.pickColor = function(id, val) {
      const cd = countdowns.find(c => c.id === id);
      if (!cd) return;
      cd.color = val;
      saveConfig();
      renderCountdowns();
    };
    window.resetTotalCountdown = function(id) {
      const cd = countdowns.find(c => c.id === id);
      if (!cd) return;
      cd.totalIteration = 1;
      saveConfig();
      renderCountdowns();
    };

    function formatTime(seconds) {
      const hrs = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      return [hrs, mins, secs].map(unit => String(unit).padStart(2, '0')).join(':');
    }

    window.toggleCountdown = function(id) {
      const cd = countdowns.find(c => c.id === id);
      if (!cd) return;
      cd.running = !cd.running;
      ensureMainTimer();
      renderCountdowns();
      saveConfig();
    };
    window.resetCountdown = function(id) {
      const cd = countdowns.find(c => c.id === id);
      if (!cd) return;
      cd.running = false;
      cd.remaining = cd.seconds;
      cd.flashing = false;
      cd.finished = false;
      cd.iteration = 1;
      renderCountdowns();
      saveConfig();
      updateTitle();
    };
    window.restartCountdown = function(id) {
      const cd = countdowns.find(c => c.id === id);
      if (!cd) return;
      cd.remaining = cd.seconds;
      cd.flashing = false;
      cd.finished = false;
      cd.iteration = (cd.iteration || 1) + 1;
      cd.totalIteration = (cd.totalIteration || 1) + 1;
      cd.running = true;
      ensureMainTimer();
      renderCountdowns();
      saveConfig();
      updateTitle();
    };
    window.removeCountdown = function(id) {
      const idx = countdowns.findIndex(c => c.id === id);
      if (idx !== -1) {
        const styleElem = document.getElementById("style-flash-"+countdowns[idx].id);
        if (styleElem) styleElem.remove();
        countdowns.splice(idx, 1);
      }
      renderCountdowns();
      saveConfig();
      updateTitle();
    };

    document.getElementById("startCountdownBtn").onclick = () => {
      const hours = parseInt(document.getElementById("cdHour").value) || 0;
      const minutes = parseInt(document.getElementById("cdMinute").value) || 0;
      const seconds = parseInt(document.getElementById("cdSecond").value) || 0;
      const total = hours * 3600 + minutes * 60 + seconds;
      const desc = document.getElementById("cdDescription").value || '';
      if (total > 0) addCountdown(total, desc);
    };

    updateDisplay();
  </script>
</body>
</html>
